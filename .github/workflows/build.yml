name: Build and Release

on:
  push:
    branches: [main]
    tags:
      - "v*"
  pull_request:
    branches: [main]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS builds
          - os: macos-15
            arch: arm64
            platform: darwin
          - os: macos-15-intel
            arch: x64
            platform: darwin
          # Windows builds (ia32 not supported in Node.js 20+)
          - os: windows-2022
            arch: x64
            platform: win32

    runs-on: ${{ matrix.os }}
    name: Build ${{ matrix.platform }}-${{ matrix.arch }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          architecture: ${{ matrix.arch }}

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Get Node.js version
        id: node-version
        shell: bash
        run: echo "version=$(node -v | sed 's/v//')" >> $GITHUB_OUTPUT

      - name: Download node.lib (Windows)
        if: matrix.platform == 'win32'
        shell: bash
        run: |
          NODE_VERSION=${{ steps.node-version.outputs.version }}
          ARCH=${{ matrix.arch }}
          mkdir -p build/Release
          curl -Lo build/node.lib "https://nodejs.org/dist/v${NODE_VERSION}/win-${ARCH}/node.lib"
          echo "Downloaded node.lib for Node.js v${NODE_VERSION} (${ARCH})"

      - name: Build native module
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "win32" ]; then
            npx cmake-js compile --CDCMAKE_JS_LIB="$(pwd)/build/node.lib"
          else
            npm run build:native
          fi
        env:
          npm_config_arch: ${{ matrix.arch }}

      - name: Create prebuild directory
        shell: bash
        run: |
          mkdir -p prebuilds/${{ matrix.platform }}-${{ matrix.arch }}
          if [ "${{ matrix.platform }}" = "win32" ]; then
            cp build/Release/NativeAudioSDK.node prebuilds/${{ matrix.platform }}-${{ matrix.arch }}/
          else
            cp build/Release/NativeAudioSDK.node prebuilds/${{ matrix.platform }}-${{ matrix.arch }}/
          fi

      - name: Upload prebuild artifact
        uses: actions/upload-artifact@v4
        with:
          name: prebuild-${{ matrix.platform }}-${{ matrix.arch }}
          path: prebuilds/
          retention-days: 7

  test:
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-15
            arch: arm64
            platform: darwin
          - os: macos-15-intel
            arch: x64
            platform: darwin
          - os: windows-2022
            arch: x64
            platform: win32

    runs-on: ${{ matrix.os }}
    name: Test ${{ matrix.platform }}-${{ matrix.arch }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          architecture: ${{ matrix.arch }}

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Download prebuild
        uses: actions/download-artifact@v4
        with:
          name: prebuild-${{ matrix.platform }}-${{ matrix.arch }}
          path: prebuilds/

      - name: Build TypeScript
        run: npm run build:ts

      - name: Test loading native module
        run: |
          node -e "
            const m = require('./dist/index.js');
            console.log('Module loaded successfully');
            console.log('AudioRecorder class exists:', typeof m.AudioRecorder === 'function');
            console.log('getDevices method exists:', typeof m.AudioRecorder.getDevices === 'function');
          "

  publish:
    needs: [build, test]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      id-token: write # Required for npm trusted publishing (OIDC)
      contents: write # Required for GitHub Release

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      # Trusted publishing requires npm 11.5.1 or later
      - name: Update npm
        run: npm install -g npm@latest

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Download all prebuilds
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Merge prebuilds
        run: |
          mkdir -p prebuilds
          for dir in artifacts/prebuild-*/; do
            cp -r "$dir"/* prebuilds/ 2>/dev/null || true
          done
          echo "Prebuilds structure:"
          find prebuilds -type f

      - name: Build TypeScript
        run: npm run build:ts

      # Uses OIDC authentication - no token needed
      - name: Publish to npm
        run: npm publish --access public

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            prebuilds/**/*.node
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
